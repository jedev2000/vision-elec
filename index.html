<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Image Processing with Groq API</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      text-align: center;
    }
    #preview {
      max-width: 100%;
      margin-top: 10px;
    }
    #result {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Image Processing with Groq API</h1>
  <input type="file" accept="image/*" capture="environment" id="cameraInput">
  <br>
  <img id="preview" src="" alt="Image preview will appear here">
  <div id="result"></div>

  <script>
    import { z } from "zod";
    import { Groq as GroqClient } from "groq-sdk";
    var groq = new GroqClient({
      apiKey: "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"
    });
    var animalIdentificationSchema = z.object({
      imageData: z.string()
    });
    // Async function to process the image data with the Groq API
    async function processImage(imageData) {
      try {
        console.log("Processing image data for identification...");
        // Remove the data URL header if present to obtain only the base64 data
        const base64Image = imageData.split(",")[1] || imageData;
        console.log("Making request to Groq API...");
        
        // Construct the payload using your chosen model and prompt:
        const payload = {
          model: "llama-3.2-90b-vision-preview",
          messages: [
            {
              role: "user",
              content: [
                {
                  type: "text",
                  text: "Please identify the animal breed or the car model (with estimated price) in this image. Provide a concise response focusing only on the breed identification."
                },
                {
                  type: "image_url",
                  image_url: {
                    // Construct a data URI from the base64 image
                    url: `data:image/jpeg;base64,${base64Image}`
                  }
                }
              ]
            }
          ],
          max_tokens: 150  // Updated parameter for token limit
        };

        // Make the API call using the Groq client library
        const response = await groq.chat.completions.create(payload);
        console.log("Groq API response:", response);
        // Extract the answer from the response (adjust if the response structure changes)
        return response.choices[0].message.content;
      } catch (error) {
        console.error("Error calling Groq API:", error);
        throw error;
      }
    }

    // Listen for image input changes
    document.getElementById('cameraInput').addEventListener('change', async event => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = async e => {
          const imageData = e.target.result;
          // Display the image preview
          document.getElementById('preview').src = imageData;
          // Show a processing message
          document.getElementById('result').textContent = 'Processing image...';
          try {
            // Process the image and get the answer from the Groq API
            const answer = await processImage(imageData);
            document.getElementById('result').textContent = answer;
          } catch (error) {
            document.getElementById('result').textContent = 'Error processing image.';
          }
        };
        reader.readAsDataURL(file);
      }
    });
  </script>
</body>
</html>
